<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Price Log Scale</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #121212; /* Dark background for the page */
            color: #ffffff; /* Light text color */
        }
        #plot {
            width: 100%;
            height: 100vh; /* Full viewport height */
        }
    </style>
</head>
<body>
    <div id="plot"></div>

    <script>
        async function fetchBitcoinData() {
            const history = await fetch('./history.json').then(x=>x.json())
        
            const response = await fetch(
                'https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=30'
            );
            const data = await response.json();

            return {
                date: [...history.date, ...data.prices.map(x => x[0]/1000)],
                price: [...history.price, ...data.prices.map(x => x[1])]
            };
        }

        // Function to plot the data
        function plotBitcoinData(history, maps){
            const yticks = [1,10,100,1000,10000,100000,1000000]
            const years = Array.from({ length: 2030 - 2011 + 1 }, (_, i) => 2011 + i);

            const trace = {
                x: history.date.map(maps.toDeltaYear),
                y: history.price,
                type: 'scatter',
                mode: 'lines', // Only lines, no markers
                name: 'Bitcoin Price',
                line: { shape: 'spline', color: '#FFA500' }, // Orange color for the line
                hoverinfo: 'x+y', // Show both x and y in hover
                // hovertemplate: 'Date: %{new Date(maps.toDate(x) * 1000).toISOString()}<br>Price: $%{maps.toPrice(y):.2f}<extra></extra>', // Custom hover template
                hovertemplate: 'Date: %{x}<br>Price: $%{y:.2f}<extra></extra>', // Custom hover template
            };
            const style={gridcolor: '#333333',linecolor: '#ffffff',tickcolor: '#ffffff'}

            const layout = {
                title: 'BTC',
                plot_bgcolor: '#121212', // Dark background for the plot
                paper_bgcolor: '#121212', // Dark background for the surrounding area
                font: { color: '#ffffff' }, // Light text color
                xaxis: {
                    title: 'Date',
                    tickvals: years.map(x => maps.toDeltaYear(new Date(`${x}-01-01T00:00:00Z`).getTime()/1000)),
                    ticktext: years.map(String),
                    type:'log',
                    ...style
                },
                yaxis: {
                    title: 'Price (USD)',
                    tickvals: yticks,
                    ticktext: yticks.map(x => x>1000?(x/1000).toString()+'k':x.toString()),
                    type:'log',
                    ...style
                }
            };

            const data = [trace];
            Plotly.newPlot('plot', data, layout);
        }

        // Fetch real Bitcoin data and combine it with hardcoded data
        async function main(){
            const history = await fetchBitcoinData();
            const toDeltaYear = x => ((x-history.date[0])/(60*60*24*365.25)+1)
            const fromDeltaYear = x => ((x-1)*(60*60*24*365.25)+history.date[0])
            const fromDate = x => Math.log((x-history.date[0])/(60*60*24*365.25)+1)
            const fromPrice = x => Math.log(x)
            const toDate = x => (Math.exp(x)-1)*(60*60*24*365.25)+history.date[0]
            const toPrice = x => Math.exp(x)
            const toLog = x=>({price: x.price.map(fromPrice), date: x.date.map(fromDate)})
            const fromLog = x=>({price: x.price.map(toPrice), date: x.date.map(toDate)})

            // Plot the transformed data with remapped labels
            plotBitcoinData(history, {toLog, fromLog, fromDate,fromPrice,toDate,toPrice,toDeltaYear,fromDeltaYear});
        }
        main()
    </script>
</body>
</html>